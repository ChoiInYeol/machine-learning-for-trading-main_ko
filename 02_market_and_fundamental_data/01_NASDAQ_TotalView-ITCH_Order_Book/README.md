# 시장 데이터 작업: NASDAQ TotalView-ITCH 주문장

FIX는 압도적인 시장 점유율을 갖고 있지만 거래소는 기본 프로토콜도 제공합니다. Nasdaq은 가입자가 지분 상품의 배치부터 실행 또는 취소까지 개별 지분 상품 주문을 추적할 수 있도록 하는 TotalView ITCH 직접 데이터 공급 프로토콜을 제공합니다.

결과적으로 특정 증권이나 금융 상품에 대한 활성 한도 매수 및 매도 주문 목록을 추적하는 주문장을 재구성할 수 있습니다. 주문서는 각 가격대에서 입찰 또는 제안된 주식 수를 나열하여 하루 종일 시장 깊이를 보여줍니다. 또한 익명으로 접수되지 않는 한 특정 매수 및 매도 주문에 책임이 있는 시장 참가자를 식별할 수도 있습니다. 시장 깊이는 유동성과 대규모 시장 주문이 가격에 미칠 수 있는 영향을 나타내는 주요 지표입니다.

나스닥은 시장 및 지정가 주문 매칭 외에도 시장 개장 및 마감 시 다수의 거래를 실행하는 경매 또는 교차를 운영합니다. 패시브 투자가 계속 성장하고 트레이더들이 더 큰 규모의 주식을 실행할 기회를 찾으면서 크로스는 더욱 중요해지고 있습니다. TotalView는 또한 Nasdaq 개시 및 마감 교차와 Nasdaq IPO/Halt 교차에 대한 순 주문 불균형 지표(NOII)를 전파합니다.

> 이 예에서는 16GB 이상의 많은 메모리가 필요합니다(저는 64GB를 사용하고 있으며 아직 최소 요구 사항을 확인하지 않았습니다). 용량 제약이 있는 경우, 이 책의 다른 어떤 것에서도 코드를 실행할 수 있는 것이 필수적인 것은 아니라는 점을 명심하십시오. 우선, 이 하루의 예보다 훨씬 더 큰 데이터를 관리하기 위해 시스템이 구축되었을 기관 투자 맥락에서 어떤 종류의 데이터로 작업할지 보여주는 것을 목표로 합니다.

## 바이너리 ITCH 메시지 구문 분석

ITCH v5.0 사양은 시스템 이벤트, 주식 특성, 지정가 주문 배치 및 수정, 거래 실행과 관련된 20개 이상의 메시지 유형을 선언합니다. 또한 시가 및 마감 교차 전의 순 주문 불균형에 대한 정보도 포함되어 있습니다.

나스닥은 몇 달 동안 일일 바이너리 파일 샘플을 제공합니다. 이 장의 GitHub 저장소에는 ITCH 메시지의 샘플 파일을 구문 분석하고 특정 틱에 대해 실행된 거래와 주문서를 재구성하는 방법을 보여주는 노트북 build_order_book.ipynb가 포함되어 있습니다.

다음 표는 책(2018년 3월 29일자)에 사용된 샘플 파일에 대한 가장 일반적인 메시지 유형의 빈도를 보여줍니다. 그 동안 코드는 2019년 3월 27일의 새로운 샘플을 사용하도록 업데이트되었습니다.

| 메시지 유형 | 주문서 영향 | 메시지 수 |
|:------------:|--------- ------------------------------------- |------:|
| A | 새로운 비귀속 지정가 주문 | 136,522,761 |
| 디 | 주문 취소 | 133,811,007 |
| 유 | 주문 취소 및 교체 | 21,941,015 |
| 전자 | 전체 또는 부분 실행 동일한 원래 주문에 대한 여러 메시지가 있을 수 있음 | 6,687,379 |
| X | 부분 취소 후 수정 | 5,088,959 |
| F | 기여된 주문 추가 | 2,718,602 |
| 피 | 트레이드 메시지(비교차) | 1,120,861 |
| 다 | 전체 또는 일부를 최초 표시가격과 다른 가격으로 체결 | 157,442 |
| 질문 | 교차 무역 메시지 | 17,233 |

각 메시지에 대해 사양은 구성 요소와 해당 길이 및 데이터 유형을 배치합니다.

| 이름 | 오프셋 | 길이 | 가치 | 메모 |
|------------|---------|---------|--- ---------|--------------- --------------------|
| 메시지 유형 | 0 | 1 | 에스 | 시스템 이벤트 메시지 |
| 재고 찾기 | 1 | 2 | 정수 | 항상 0 |
| 추적 번호 | 3 | 2 | 정수 | 나스닥 내부 추적 번호 |
| 타임스탬프 | 5 | 6 | 정수 | 자정 이후 나노초 |
| 주문 참조 번호 | 11 | 8 | 정수 | 수령 시 새 주문에 할당된 고유 참조 번호입니다.        |
| 매수/매도 지표 | 19 | 1 | 알파 | 추가되는 주문 유형입니다. B = 구매 주문. S = 매도 주문.                        |
| 주식 | 20 | 4 | 정수 | 책에 추가되는 주문과 관련된 총 주식 수입니다.        |
| 주식 | 24 | 8 | 알파 | 공백으로 채워진 오른쪽 주식 기호 |
| 가격 | 32 | 4 | 가격(4) | 새 주문의 표시 가격입니다. 필드 처리 참고 사항은 데이터 유형을 참조하세요.  |
| 기여 | 36 | 4 | 알파 | 입력된 주문과 관련된 Nasdaq Market 참가자 식별자 |

노트북 [01_build_itch_order_book](01_parse_itch_order_flow_messages.ipynb), [02_리빌드_나스닥_주문_북](02_rebuild_nasdaq_order_book.ipynb) 및 [03_normalize_tick_data](03_normalize_tick_data.ipynb)에는 다음을 수행하는 코드가 포함되어 있습니다.
- NASDAQ Total View 샘플 틱 데이터 다운로드,
- 바이너리 소스 데이터의 메시지를 구문 분석합니다.
- 특정 주식에 대한 주문서를 재구성합니다.
- 주문 흐름 데이터 시각화
- 틱 데이터 정규화

2019년 3월 27일자 최신 NASDAQ 샘플 파일을 사용하도록 코드가 업데이트되었습니다.

경고: 틱 데이터의 크기는 약 12GB이며 일부 처리 단계는 32GB RAM을 갖춘 4코어 i7 CPU에서 몇 시간이 걸릴 수 있습니다.

## 틱 데이터 정규화

거래 데이터는 나노초 단위로 색인화되며 매우 시끄럽습니다. 예를 들어, 매수-매도 바운스로 인해 거래 개시가 매수 및 매도 시장 주문 사이에서 번갈아 시작될 때 가격이 매수 가격과 매도 가격 사이에서 진동하게 됩니다. 잡음-신호 비율을 개선하고 통계적 특성을 개선하려면 거래 활동을 집계하여 틱 데이터를 다시 샘플링하고 정규화해야 합니다.

우리는 일반적으로 집계된 기간의 시가(첫 번째), 저가, 고가 및 종가(마지막)를 거래량 가중 평균 가격(VWAP), 거래된 주식 수 및 데이터와 관련된 타임스탬프와 함께 수집합니다.

노트북 [03_normalize_tick_data](03_normalize_tick_data.ipynb)은 다양한 집계 방법을 사용하는 시간 및 볼륨 막대를 사용하여 잡음이 있는 틱을 정규화하는 방법을 보여줍니다.