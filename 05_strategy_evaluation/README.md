# 포트폴리오 최적화 및 성과 평가

시장 상황에서 전략을 구현하기 전에 테스트하려면 알고리즘이 수행하는 거래를 시뮬레이션하고 그 성과를 검증해야 합니다. 전략 평가에는 전략의 매개변수를 최적화하기 위한 과거 데이터에 대한 백테스트와 샘플 외부의 새로운 데이터에 대해 샘플 내 성능을 검증하기 위한 전방 테스트가 포함됩니다. 목표는 특정 과거 상황에 맞게 전략을 조정하여 잘못된 발견을 방지하는 것입니다.

포트폴리오 맥락에서 긍정적인 자산 수익률은 부정적인 가격 변동을 상쇄할 수 있습니다. 한 자산의 긍정적인 가격 변화는 두 포지션 간의 상관관계가 낮을수록 다른 자산의 손실을 상쇄할 가능성이 높습니다. 포트폴리오 위험이 포지션의 공분산에 어떻게 의존하는지에 기초하여 Harry Markowitz는 1952년 다각화를 기반으로 한 현대 포트폴리오 관리의 기본 이론을 개발했습니다. 그 결과 위험을 최소화하기 위해 특정 자산 집합에 대한 가중치를 선택하는 평균 분산 최적화가 이루어졌습니다. 주어진 기대 수익률에 대한 수익률의 표준 편차입니다.

CAPM(자본 자산 가격 책정 모델)은 자산 보유에 대한 균형 보상으로 무위험 투자를 초과하는 기대 수익으로 측정되는 위험 프리미엄을 도입합니다. 이 보상은 자산에 특이하지 않고 체계적이어서 다양화할 수 없는 단일 위험 요소인 시장에 대한 노출을 보상합니다.

추가 위험 요소와 노출에 대한 보다 세분화된 선택이 등장함에 따라 위험 관리는 더욱 정교해졌습니다. Kelly 기준은 시간이 지남에 따라 일련의 위치를 ​​선택하는 동적 포트폴리오 최적화에 대한 인기 있는 접근 방식입니다. 1968년 Edward Thorp가 도박에 처음 적용한 것을 주식 시장에 적용한 것으로 유명합니다.

결과적으로, 자산 간의 계층적 관계를 학습하고 해당 보유 자산을 포트폴리오 위험 프로필과 관련하여 보완재 또는 대체재로 처리하기 위한 기계 학습(ML) 적용을 포함하는 포트폴리오를 최적화하는 여러 가지 접근 방식이 있습니다. 이 장에서는 다음 주제를 다룹니다.

## 콘텐츠

1. __자리표시자_0__
    * __자리표시자_1__
    * __자리표시자_2__
2. __자리표시자_3__
    * __자리표시자_4__
    * __자리표시자_5__
        - __자리표시자_6__
    * __자리표시자_7__
        - __자리표시자_8__
        - __자리표시자_9__
        - __자리표시자_10__
        - __자리표시자_11__
        - __자리표시자_12__
    * __자리표시자_13__
3. __자리표시자_14__
    * __자리표시자_15__
4. __자리표시자_16__
    * __자리표시자_17__

## 포트폴리오 성과를 측정하는 방법

다양한 전략을 평가 및 비교하거나 기존 전략을 개선하려면 목표와 관련된 성과를 반영하는 측정 기준이 필요합니다. 투자와 거래에서 가장 일반적인 목표는 **투자 포트폴리오의 수익과 위험**입니다.

수익 및 위험 목표는 균형을 의미합니다. 더 많은 위험을 감수하면 어떤 상황에서는 더 높은 수익을 얻을 수 있지만 더 큰 단점도 암시합니다. 다양한 전략이 이러한 절충안을 어떻게 해결하는지 비교하기 위해 위험 단위당 수익률을 계산하는 비율이 매우 널리 사용됩니다. **샤프 비율**과 **정보 비율**(IR)에 대해 차례로 논의하겠습니다.

### (조정된) 샤프 비율

사전 샤프 비율(SR)은 포트폴리오의 예상 초과 포트폴리오를 표준 편차로 측정된 초과 수익의 변동성과 비교합니다. 이는 감수한 위험 단위당 평균 초과 수익으로 보상을 측정합니다. 데이터를 통해 추정할 수 있습니다.

재정적 수익은 종종 iid 가정을 위반합니다. Andrew Lo는 고정되어 있지만 자기상관된 수익에 대한 분포 및 시간 집계에 필요한 조정을 도출했습니다. 이는 투자 전략의 시계열 속성(예: 평균 회귀, 모멘텀 및 기타 형태의 계열 상관 관계)이 SR 추정자 자체에 적지 않은 영향을 미칠 수 있기 때문에 중요합니다. 특히 더 높은 빈도에서 SR을 연간화할 때 더욱 그렇습니다. 데이터.

- [샤프비율 통계](https://www.jstor.org/stable/4480405?seq=1#page_scan_tab_contents), Andrew Lo, 재무 분석가 저널, 2002

### 액티브 경영의 기본 법칙

[제1장](../01_machine_learning_for_trading)에서 언급한 Jim Simons가 설립한 최고의 퀀트 펀드인 Renaissance Technologies(RenTec)가 매우 다른 접근 방식에도 불구하고 Warren Buffet과 유사한 수익을 창출했다는 것은 흥미로운 사실입니다. Warren Buffet의 투자 회사인 Berkshire Hathaway는 꽤 오랫동안 약 100~150개의 주식을 보유하고 있는 반면 RenTec은 하루에 100,000건의 거래를 실행할 수 있습니다. 이러한 서로 다른 전략을 어떻게 비교할 수 있습니까?

ML은 목적 함수를 최적화하는 것입니다. 알고리즘 거래에서 목표는 일반적으로 벤치마크(현금, 무위험 이자율 또는 S&P 500과 같은 자산 가격 지수일 수 있음)와 관련된 전체 투자 포트폴리오의 수익 및 위험입니다.

높은 IR(정보 비율)은 추가 위험에 비해 매력적인 성과를 의미합니다. 액티브 관리의 기본 법칙은 IR을 예측 기술의 척도인 정보 계수(IC)와 독립적인 베팅을 통해 이 기술을 적용하는 능력으로 분류합니다. 자주 플레이하는 것(높은 폭)과 잘 플레이하는 것(높은 IC)의 중요성을 요약합니다.

IC는 알파 팩터와 해당 신호로 인한 전방 수익 사이의 상관관계를 측정하고 관리자의 예측 기술의 정확성을 포착합니다. 전략의 폭은 특정 기간 동안 투자자가 독립적인 베팅 수로 측정하며, 두 값의 곱은 평가 위험이라고도 알려진 IR에 비례합니다(Treynor 및 Black).

기본법칙은 초과성과의 핵심 동인을 강조하기 때문에 중요합니다. 즉, 정확한 예측과 독립적인 예측을 하고 이러한 예측에 따라 조치를 취하는 능력이 모두 중요합니다. 실제로 예측 간의 단면적 및 시계열 상관관계를 고려할 때 전략의 폭을 추정하는 것은 어렵습니다.

- [적극적인 포트폴리오 관리: 우수한 수익 창출 및 위험 통제를 위한 정량적 접근 방식](https://www.amazon.com/Active-Portfolio-Management-Quantitative-Controlling/dp/0070248826) 작성자: Richard Grinold 및 Ronald Kahn, 1999
- [포트폴리오 선택을 개선하기 위해 보안 분석을 사용하는 방법](https://econpapers.repec.org/article/ucpjnlbus/v_3a46_3ay_3a1973_3ai_3a1_3ap_3a66-86.htm), Jack L Treynor 및 Fischer Black, 비즈니스 저널, 1973
- [포트폴리오 제약과 액티브 운용의 기본법칙](https://faculty.fuqua.duke.edu/~charvey/Teaching/BA491_2005/Transfer_coefficient.pdf), Clarke 외 2002

## 포트폴리오 위험 및 수익을 관리하는 방법

포트폴리오 관리는 벤치마크와 관련하여 원하는 위험-수익 균형을 달성하는 금융 상품의 포지션을 선택하고 크기를 조정하는 것을 목표로 합니다. 포트폴리오 관리자로서 귀하는 각 기간마다 목표 수익을 달성하는 동시에 위험을 줄이기 위해 다각화를 최적화하는 포지션을 선택합니다. 기간 전반에 걸쳐 이러한 포지션은 목표 위험 프로필을 달성하거나 유지하기 위해 가격 변동으로 인한 가중치 변화를 설명하기 위해 재조정이 필요할 수 있습니다.

### 현대 포트폴리오 관리의 진화

다각화를 통해 우리는 불완전한 상관관계를 통해 한 자산의 이익이 다른 자산의 손실을 보상할 수 있는 방법을 활용하여 주어진 기대 수익에 대한 위험을 줄일 수 있습니다. Harry Markowitz는 1952년에 현대 포트폴리오 이론(MPT)을 창안했으며 적절한 포트폴리오 가중치를 선택하여 다양화를 최적화할 수 있는 수학적 도구를 제공했습니다.
 
### 평균-분산 최적화

현대 포트폴리오 이론은 주어진 기대 수익률에 대한 변동성을 최소화하거나 주어진 변동성 수준에 대한 수익률을 최대화하기 위해 최적의 포트폴리오 가중치를 해결합니다. 주요 필수 입력은 예상 자산 수익률, 표준 편차 및 공분산 행렬입니다. 
- [포트폴리오 선택](https://www.math.ust.hk/~maykwok/courses/ma362/07F/markowitz_JF.pdf), Harry Markowitz, The Journal of Finance, 1952
- [자본 자산 가격 결정 모델: 이론 및 증거](http://mba.tuck.dartmouth.edu/bespeneckbo/default/AFA611-Eckbo%20web%20site/AFA611-S6B-FamaFrench-CAPM-JEP04.pdf), Eugene F. Fama 및 Kenneth R. French, 경제 관점 저널, 2004

#### 코드 예제: Python에서 효율적인 경계 찾기

scipy.optimize.minimize와 자산 수익률, 표준 편차 및 공분산 행렬에 대한 과거 추정치를 사용하여 효율적인 경계를 계산할 수 있습니다. 
- 파이썬에서 효율적인 경계선을 계산하기 위한 노트북 [평균_분산_최적화](04_mean_variance_optimization.ipynb).

### 평균 분산 최적화의 대안

평균-분산 최적화 문제에 대한 정확한 입력의 어려움으로 인해 평균, 분산 또는 둘 다를 제한하거나 우리가 논의하는 위험 패리티 접근 방식과 같이 더 어려운 수익 추정치를 생략하는 여러 가지 실용적인 대안을 채택하게 되었습니다. 이 섹션의 뒷부분에서 설명합니다.

#### 1/N 포트폴리오

단순 포트폴리오는 과적합 위험을 생성하는 복잡한 모델의 부가가치를 측정하는 데 유용한 벤치마크를 제공합니다. 가장 단순한 전략, 즉 동일 가중치 포트폴리오가 최고의 성과를 내는 것으로 나타났습니다.

#### 최소 분산 포트폴리오

또 다른 대안은 위험 최소화를 우선시하는 글로벌 최소 분산(GMV) 포트폴리오입니다. 이는 효율적인 프론티어 그림으로 나타나며, 평균-분산 체계를 이용하여 포트폴리오 표준편차를 최소화하여 다음과 같이 계산할 수 있습니다.

#### Black-Litterman 접근 방식

Black and Litterman(1992)의 글로벌 포트폴리오 최적화 접근법은 경제 모델과 통계적 학습을 결합하고 많은 상황에서 그럴듯한 기대 수익 추정치를 생성하기 때문에 인기가 있습니다.
이 기술은 CAPM 균형 모델이 암시하는 바와 같이 시장이 평균-분산 포트폴리오라고 가정합니다. 이는 관찰된 시가총액이 시장에서 각 증권에 할당된 최적의 가중치로 간주될 수 있다는 사실을 기반으로 합니다. 시장 가중치는 미래 수익에 대한 시장의 기대를 구체화하는 시장 가격을 반영합니다.

- [글로벌 포트폴리오 최적화](http://www.sef.hku.hk/tpg/econ6017/2011/black-litterman-1992.pdf), 블랙, 피셔; 리터맨, 로버트
재무 분석가 저널, 1992

#### 베팅 규모를 결정하는 방법 – 켈리 법칙

켈리 규칙은 최종 부를 극대화하기 위해 다양한(그러나 유리한) 확률로 각 (무한한) 일련의 베팅에 얼마나 많은 돈을 걸어야 하는지에 대한 지침을 제공하기 때문에 도박에서 오랜 역사를 가지고 있습니다. 이는 1956년 Bell Labs의 Claude Shannon의 동료인 John Kelly에 의해 A New Interpretation of the Information Rate로 출판되었습니다. 그는 새로운 퀴즈 쇼인 The $64,000 Question에서 후보자에게 베팅한 것에 흥미를 느꼈습니다. 이 프로그램에서 서부 해안의 한 시청자는 3시간의 지연 시간을 이용해 우승자에 대한 내부 정보를 얻었습니다.

Kelly는 승률이 양호하지만 불확실성이 남아 있는 경우 장기 자본 성장에 최적인 베팅을 해결하기 위해 Shannon의 정보 이론과 연결시켰습니다. 그의 규칙은 각 게임의 성공 확률에 따라 로그 부를 극대화하고 log(0)이 음의 무한대이므로 암묵적인 파산 보호를 포함하므로 Kelly 도박꾼은 자연스럽게 모든 것을 잃지 않을 것입니다.

- [정보율의 새로운 해석](https://www.princeton.edu/~wbialek/rome/refs/kelly_56.pdf), 존 켈리, 1956
- [딜러를이기십시오 : 21 게임의 승리 전략](https://www.amazon.com/Beat-Dealer-Winning-Strategy-Twenty-One/dp/0394703103), 에드워드 O. 소프, 1966
- [시장을 이기세요: 과학적인 주식 시장 시스템](https://www.researchgate.net/publication/275756748_Beat_the_Market_A_Scientific_Stock_Market_System), 에드워드 O. 소프, 1967
- [정량 거래: 나만의 알고리즘 거래 사업을 구축하는 방법](https://www.amazon.com/Quantitative-Trading-Build-Algorithmic-Business/dp/0470284889/ref=sr_1_2?s=books&ie=UTF8&qid=1545525861&sr=1-2), 어니 찬, 2008

#### Python을 사용한 MV 최적화의 대안

- 노트북 [켈리_규칙](05_kelly_rule.ipynb)은 단일 및 다중 자산 사례에 대한 애플리케이션을 보여줍니다. 
- 후자의 결과는 몇 가지 다른 대체 접근 방식과 함께 노트북 [평균_분산_최적화](04_mean_variance_optimization.ipynb)에도 포함되어 있습니다.

### 계층적 위험 동등성

[마르코스 로페즈 드 프라도](http://www.quantresearch.org/)이 개발한 이 새로운 접근 방식은 일반적으로 2차 최적화 프로그램과 특히 Markowitz의 임계선 알고리즘(CLA)의 세 가지 주요 문제를 해결하는 것을 목표로 합니다. 
- 불안정성, 
- 집중력, 그리고 
- 실적이 저조합니다.

계층적 위험 패리티(HRP)는 그래프 이론과 기계 학습을 적용하여 공분산 행렬에 포함된 정보를 기반으로 다양한 포트폴리오를 구축합니다. 그러나 2차 최적화 프로그램과 달리 HRP에는 공분산 행렬의 가역성이 필요하지 않습니다. 실제로 HRP는 잘못 생성된 또는 단일 공분산 행렬에서 포트폴리오를 계산할 수 있습니다. 이는 2차 최적화 프로그램으로는 불가능한 작업입니다. 몬테카를로 실험에서는 최소 분산이 CLA의 최적화 목표임에도 불구하고 HRP가 CLA보다 표본 외 분산이 더 낮다는 것을 보여줍니다. HRP는 또한 전통적인 위험 평가 방법에 비해 샘플에서 덜 위험한 포트폴리오를 생성합니다. 계층적 클러스터링을 포함한 비지도 학습을 거래에 적용하는 방법을 논의할 때 [제13장](../13_unsupervised_learning)에서 HRP에 대해 더 자세히 논의할 것입니다.

- [샘플을 능가하는 다양한 포트폴리오 구축](https://jpm.pm-research.com/content/42/4/59.short), Marcos López de Prado, 포트폴리오 관리 저널 42, no. 4 (2016): 59-69.
- [계층적 클러스터링 기반 자산 배분](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2840729), 토마스 라피노, 2016

HRP를 구현하는 방법을 보여주고 계층적 클러스터링도 소개하는 [비지도 학습](../13_unsupervised_learning)의 13장에서 대안과 비교합니다.

## `Zipline`을(를) 사용하여 포트폴리오 거래 및 관리

오픈 소스 [지퍼 라인](https://zipline.ml4trading.io/index.html) 라이브러리는 알고리즘 개발 및 실시간 거래를 촉진하기 위해 크라우드 소싱 정량 투자 펀드 [양자역학](https://www.quantopian.com/)에서 생산에 유지 관리하고 사용하는 이벤트 중심 백테스팅 시스템입니다. 이는 거래 이벤트에 대한 알고리즘의 반응을 자동화하고 예측 편향을 방지하는 현재 및 과거 시점 데이터를 제공합니다. [8장 - ML4T 작업 흐름](../08_strategy_workflow)에는 `zipline` 및 `backtrader`을 모두 사용하는 백테스팅에 대한 보다 자세하고 헌신적인 소개가 있습니다.

[제4장](../04_alpha_factor_research)에서는 후행 횡단면 시장, 기본 및 대체 데이터로부터 알파 팩터 계산을 시뮬레이션하기 위해 `zipline`을 도입했습니다. 이제 우리는 알파 팩터를 활용하여 구매 및 판매 신호를 도출하고 이에 따라 조치를 취할 것입니다.

### 코드 예제: 거래 및 포트폴리오 최적화를 통한 백테스트

이 섹션의 코드는 다음 두 노트북에 있습니다. 
- 이 섹션의 노트북은 `conda` 환경 `backtest`을 사용합니다. 최신 Docker 이미지를 다운로드하거나 환경을 설정하는 다른 방법을 보려면 [지침](../installation/README.md) 설치를 참조하세요.
- 노트북 [백테스트_with_trades](01_backtest_with_trades.ipynb)은 Zipline을 사용하여 마지막 장의 간단한 MeanReversion 알파 요소를 기반으로 포트폴리오를 구축하는 거래 결정을 시뮬레이션합니다. 우리는 포트폴리오 가중치를 명시적으로 최적화하지 않고 각 보유에 동일한 가치의 포지션을 할당합니다.
- [백테스트_with_pf_최적화](02_backtest_with_pf_optimization.ipynb) 노트북은 간단한 전략 백테스트의 일부로 PF 최적화를 사용하는 방법을 보여줍니다.

## `pyfolio`을 사용하여 백테스트 성능 측정

Pyfolio는 다양한 표준 지표를 사용하여 샘플 내외의 포트폴리오 성과 및 위험 분석을 용이하게 합니다. 여러 기본 제공 시나리오를 사용하여 시장 스트레스 기간 동안의 이벤트 위험은 물론 수익, 포지션, 거래 분석을 다루는 테어시트를 생성하고 베이지안 표본 외 성능 분석도 포함합니다.

### 코드 예: `Zipline` 백테스트의 `pyfolio` 평가

[pyfolio_demo](03_pyfolio_demo.ipynb) 노트북은 이전 폴더에서 수행된 백테스트에서 `pyfolio` 입력을 추출하는 방법을 보여줍니다. 그런 다음 `pyfolio`을 사용하여 여러 성능 지표와 테어시트를 계산합니다.

- 이 노트북에는 `conda` 환경 `backtest`이 필요합니다. 최신 Docker 이미지를 실행하거나 환경을 설정하는 대체 방법은 [설치 지침](../installation/README.md)을 참조하세요.